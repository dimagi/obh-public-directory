# Automated pull of data needed for the public directory from an HQ UCR API endpoint.
# Data is pushed to S3 bucket for use by the static site. Authentication with HQ
# occurs via an API key, while authentication with AWS happens via OIDC.
name: get-then-push-data
on:
  # schedule:
  # Run at 12:30AM, 3:30 AM, 6:30 AM... every day
  #   - cron: '30 0,3,6,9,12,15,18,21 * * 1,3'
  #   - cron: '30 5 * * 2,4'
  push:
    branches:
      - ad/ucrs-endpoint-workflow
env:
  BUCKET_NAME : ${{ secrets.S3_BUCKET_NAME }}
  AWS_REGION : ${{ secrets.AWS_REGION }}
  HQ_API_KEY : ${{ secrets.ADDISONS_TEST_HQ_API_KEY }}
jobs:
  get-data-then-push:
    runs-on: ubuntu-latest
    # Get JWT token from GitHub's OIDC provider
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Get data from the HQ API
        run: |
          curl -H "Authorization: ApiKey ${{ secrets.ADDISONS_TEST_API_USERNAME }}:${{ secrets.ADDISONS_TEST_HQ_API_KEY }}" 'https://www.commcarehq.org/a/${{ secrets.PROJECT_NAME }}/api/v0.5/configurablereportdata/${{ secrets.REPORT_ID }}/' >> directory_data.json
      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::731870575956:role/CO-OBH-PublicDirectoryOIDC
          role-session-name: CO-OBH-Public-Dir-Push
          aws-region: ${{ env.AWS_REGION }}
      - name: Copy data file to s3
        run: |
          aws s3 cp directory_data.json s3://${{ env.BUCKET_NAME }}/
